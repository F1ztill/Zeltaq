<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Zeltaq Messenger</title>
    <!-- Favicon -->
    <link type="image/x-icon" rel="shortcut icon" href="favicon.ico">
    <link rel="shortcut icon" href="—Ñ—Ä–µ–π–º 1 (1).png" type="image/png">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ + –Ω–æ–≤—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif}
        body{background:linear-gradient(135deg,#1a2a6c,#2a3a7c);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:10px}
        .auth-container{width:100%;max-width:400px;background:#0f1a30;border-radius:20px;padding:30px 20px;box-shadow:0 15px 50px rgba(0,0,0,0.3)}
        .auth-form{display:none}
        .auth-form.active{display:block}
        .auth-logo{text-align:center;margin-bottom:30px}
        .logo-large{width:70px;height:70px;background:#4fc3f7;border-radius:50%;margin:0 auto 15px}
        .auth-title{color:#4fc3f7;text-align:center;margin-bottom:30px;font-size:28px}
        .auth-input{width:100%;padding:15px;margin-bottom:20px;border:none;border-radius:10px;background:#1e3258;color:white;font-size:16px}
        .auth-button{width:100%;padding:15px;border:none;border-radius:10px;background:#4fc3f7;color:#0f1a30;font-size:16px;font-weight:bold;cursor:pointer;transition:background 0.3s;margin-bottom:20px}
        .auth-button:hover{background:#29b6f6}
        .auth-button:disabled{background:#2a3a5c;color:#8c9db5;cursor:not-allowed}
        .auth-switch{text-align:center;color:#8c9db5}
        .auth-link{color:#4fc3f7;cursor:pointer;text-decoration:underline}
        .error-message{color:#ff5252;text-align:center;margin-bottom:15px;font-size:14px;display:none}
        .messenger{width:100%;max-width:1200px;height:90vh;background:#0f1a30;border-radius:20px;display:none;flex-direction:column;overflow:hidden;box-shadow:0 15px 50px rgba(0,0,0,0.3)}
        .messenger-header{background:#152642;padding:10px 15px;border-bottom:1px solid #2a3a5c;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
        .header-left{display:flex;align-items:center;gap:10px}
        .edit-icon{font-size:20px;cursor:pointer;color:#4fc3f7;background:none;border:none;padding:5px;border-radius:50%;transition:background 0.3s}
        .edit-icon:hover{background:#1e3258}
        .profile-icon{font-size:20px;cursor:pointer;color:#4fc3f7;background:none;border:none;padding:5px;border-radius:50%;transition:background 0.3s}
        .profile-icon:hover{background:#1e3258}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:#4fc3f7;position:relative;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;flex-shrink:0;cursor:pointer}
        .online-status{position:absolute;bottom:0;right:0;width:12px;height:12px;background:#4caf50;border:2px solid #0f1a30;border-radius:50%}
        .logout-btn{background:#ff5252;color:white;border:none;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:14px}
        .messenger-content{display:flex;flex:1;overflow:hidden;flex-direction:row}
        .sidebar{width:30%;background:#152642;border-right:1px solid #2a3a5c;padding:15px;overflow-y:auto;display:flex;flex-direction:column;transition:width 0.3s ease}
        .header{display:flex;align-items:center;margin-bottom:20px}
        .logo{width:40px;height:40px;background:#4fc3f7;border-radius:50%;margin-right:10px;flex-shrink:0}
        .search-container{position:relative;width:100%;margin-bottom:15px}
        .search-bar{background:#1e3258;border:none;padding:12px;border-radius:25px;color:white;width:100%;font-size:14px}
        .search-results{background:#1e3258;border-radius:10px;margin-top:5px;max-height:200px;overflow-y:auto;display:none;position:absolute;width:100%;z-index:100;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
        .search-result-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #2a3a5c;display:flex;align-items:center;gap:10px}
        .search-result-item:hover{background:#2a3a7c}
        .tabs{display:flex;margin-bottom:20px;background:#1e3258;border-radius:10px;padding:5px}
        .tab{flex:1;text-align:center;padding:8px 5px;cursor:pointer;border-radius:8px;color:#8c9db5;transition:all 0.3s;font-size:14px}
        .tab.active{background:#4fc3f7;color:#0f1a30;font-weight:bold}
        .contact-list{flex:1;overflow-y:auto}
        .contact{display:flex;align-items:center;padding:12px;border-radius:15px;margin-bottom:8px;cursor:pointer;transition:background 0.3s;position:relative}
        .contact:hover,.contact.active{background:#1e3258}
        .contact-avatar{width:45px;height:45px;border-radius:50%;background:#4db6ac;margin-right:12px;position:relative;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;flex-shrink:0}
        .contact-online{position:absolute;bottom:2px;right:2px;width:10px;height:10px;background:#4caf50;border:2px solid #152642;border-radius:50%}
        .contact-offline{position:absolute;bottom:2px;right:2px;width:10px;height:10px;background:#ff5252;border:2px solid #152642;border-radius:50%}
        .contact-info{flex:1;min-width:0}
        .contact-info h4{color:white;font-size:15px;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .contact-info p{color:#8c9db5;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .chat-area{flex:1;display:flex;flex-direction:column;background:#0f1a30;min-width:0}
        .chat-header{padding:12px 15px;background:#152642;border-bottom:1px solid #2a3a5c;display:flex;align-items:center;gap:15px;cursor:pointer}
        .back-button{background:none;border:none;color:#4fc3f7;font-size:24px;cursor:pointer;display:none;line-height:1}
        .chat-contact-avatar{width:45px;height:45px;border-radius:50%;background:#4db6ac;position:relative;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;flex-shrink:0}
        .chat-contact-info{min-width:0;flex:1}
        .chat-contact-info h3{color:white;font-size:16px;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .chat-contact-info p{color:#4caf50;font-size:12px}
        .messages{flex:1;padding:15px;overflow-y:auto;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%234fc3f7" width="100" height="100"/></svg>');display:flex;flex-direction:column}
        .message{max-width:80%;padding:10px 14px;margin:6px 0;border-radius:18px;line-height:1.4;position:relative;word-wrap:break-word;cursor:context-menu}
        .received{background:#1e3258;color:white;border-bottom-left-radius:5px;align-self:flex-start}
        .sent{background:#4fc3f7;color:#0f1a30;border-bottom-right-radius:5px;align-self:flex-end}
        .gift-message{max-width:60%;margin:10px auto;padding:15px;border-radius:20px;background:rgba(79,195,247,0.15);backdrop-filter:blur(5px);border:1px solid rgba(79,195,247,0.3);text-align:center;align-self:center;color:white}
        .gift-emoji{font-size:48px;margin-bottom:5px}
        .gift-sender{font-size:14px;color:#8c9db5;margin-top:5px}
        .reply-indicator{font-size:0.8em;color:#8c9db5;border-left:2px solid #4fc3f7;padding-left:8px;margin-bottom:4px;cursor:pointer}
        .reply-indicator:hover{text-decoration:underline;color:#4fc3f7}
        .edited-indicator{font-size:0.7em;color:#8c9db5;margin-left:5px;font-style:italic}
        .deleted-message{color:#8c9db5;font-style:italic;text-align:center}
        .message-time{font-size:0.7em;opacity:0.7;margin-top:5px;text-align:right}
        .input-area{padding:15px;background:#152642;display:flex;gap:10px;align-items:center}
        .message-input{flex:1;padding:12px 15px;border:none;border-radius:25px;background:#1e3258;color:white;font-size:14px;min-width:0}
        .send-button{background:#4fc3f7;border:none;width:45px;height:45px;border-radius:50%;color:white;cursor:pointer;transition:transform 0.2s;font-size:20px;flex-shrink:0}
        .send-button:hover{transform:scale(1.05)}
        .context-menu{position:absolute;background:#152642;border-radius:8px;padding:5px;box-shadow:0 2px 10px rgba(0,0,0,0.3);z-index:1000;display:none}
        .context-menu-item{padding:8px 12px;color:white;cursor:pointer;border-radius:4px}
        .context-menu-item:hover{background:#1e3258}
        ::-webkit-scrollbar{width:5px}
        ::-webkit-scrollbar-track{background:#1e3258}
        ::-webkit-scrollbar-thumb{background:#4fc3f7;border-radius:3px}
        .no-chat-selected{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#8c9db5;text-align:center;padding:20px}
        .no-chat-icon{font-size:50px;margin-bottom:15px;color:#4fc3f7}
        .username-tag{background:#4fc3f7;color:#0f1a30;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:bold;margin-left:5px;white-space:nowrap}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center}
        .modal.active{display:flex}
        .modal-content{background:#0f1a30;border-radius:20px;padding:30px;width:90%;max-width:400px;box-shadow:0 15px 50px rgba(0,0,0,0.5)}
        .modal-title{color:#4fc3f7;margin-bottom:20px;text-align:center}
        .modal-input{width:100%;padding:12px;margin-bottom:15px;border:none;border-radius:10px;background:#1e3258;color:white;font-size:14px}
        .modal-buttons{display:flex;gap:10px;margin-top:20px}
        .modal-button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
        .modal-button.save{background:#4fc3f7;color:#0f1a30}
        .modal-button.cancel{background:#ff5252;color:white}
        .profile-modal .gift-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0}
        .gift-item{width:60px;height:60px;border-radius:10px;background:#1e3258;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.2s}
        .gift-item:hover{transform:scale(1.1);background:#2a3a7c}
        .gift-emoji{font-size:30px}
        .gift-price{font-size:12px;color:#ffd700}
        .received-gift{display:flex;align-items:center;gap:10px;padding:8px;background:#1e3258;border-radius:10px;margin-bottom:5px;cursor:pointer}
        .received-gift:hover{background:#2a3a7c}
        .sparks-balance{color:#ffd700;font-weight:bold;margin-left:10px}
        .buy-sparks-btn{background:#4caf50;color:white;border:none;padding:8px 15px;border-radius:8px;cursor:pointer;margin:10px 0}
        @media (max-width:768px){
            .messenger-content{position:relative}
            .sidebar{width:100%;height:100%;border-right:none;border-bottom:1px solid #2a3a5c;transition:transform 0.3s ease}
            .chat-area{width:100%;height:100%;position:absolute;top:0;left:0;background:#0f1a30;transform:translateX(100%);transition:transform 0.3s ease;z-index:10}
            .chat-area.active{transform:translateX(0)}
            .back-button{display:inline-block}
            .search-results{max-height:150px}
            .message{max-width:90%}
            .gift-message{max-width:80%}
            .gift-item{width:50px;height:50px}
            .gift-emoji{font-size:24px}
        }
        @media (max-width:480px){
            .messenger-header{flex-direction:row;align-items:center}
            .header-left{flex:1}
            .logout-btn{padding:6px 12px;font-size:13px}
            .sidebar{padding:10px}
            .contact-avatar{width:40px;height:40px;margin-right:8px}
            .contact-info h4{font-size:14px}
            .contact-info p{font-size:11px}
            .chat-contact-avatar{width:40px;height:40px}
            .message-input{padding:10px}
            .send-button{width:40px;height:40px}
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
    <div class="context-menu" id="messageContextMenu">
        <div class="context-menu-item" onclick="contextMenuAction('reply')">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="context-menu-item" onclick="contextMenuAction('edit')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="context-menu-item" onclick="contextMenuAction('delete')">–£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="auth-container" id="authContainer">
        <div class="auth-logo"><div class="logo-large"></div><h1 class="auth-title">Zeltaq</h1></div>
        <div class="auth-form active" id="loginForm">
            <div class="error-message" id="loginError"></div>
            <input type="email" class="auth-input" id="loginEmail" placeholder="Email">
            <input type="password" class="auth-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-button" onclick="login()">–í–æ–π—Ç–∏</button>
            <div class="auth-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="auth-link" onclick="showRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span></div>
        </div>
        <div class="auth-form" id="registerForm">
            <div class="error-message" id="registerError"></div>
            <input type="text" class="auth-input" id="registerUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (username)" maxlength="20">
            <input type="text" class="auth-input" id="registerName" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="email" class="auth-input" id="registerEmail" placeholder="Email">
            <input type="password" class="auth-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button class="auth-button" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div class="auth-switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="auth-link" onclick="showLogin()">–í–æ–π—Ç–∏</span></div>
        </div>
    </div>

    <!-- –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä -->
    <div class="messenger" id="messenger">
        <div class="messenger-header">
            <div class="header-left">
                <button class="edit-icon" onclick="openEditProfileModal()">‚úé</button>
                <button class="profile-icon" onclick="openProfileModal(currentUser?.uid)">U</button>
                <div class="user-avatar" id="userAvatar" onclick="openEditProfileModal()">U</div>
            </div>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="messenger-content">
            <div class="sidebar" id="sidebar">
                <div class="header"><div class="logo"></div><h2 style="color:#4fc3f7;">Zeltaq</h2></div>
                <div class="tabs">
                    <div class="tab active" id="chatsTab" onclick="switchTab('chats')">–ß–∞—Ç—ã</div>
                    <div class="tab" id="globalTab" onclick="switchTab('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</div>
                </div>
                <div class="search-container" id="searchContainer" style="display:none;">
                    <input type="text" class="search-bar" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="contact-list" id="contactList"></div>
            </div>
            <div class="chat-area" id="chatArea">
                <div class="chat-header" id="chatHeader" style="display:none;" onclick="openProfileModal(selectedContact?.id)">
                    <button class="back-button" onclick="event.stopPropagation(); closeChat()">‚Üê</button>
                    <div class="chat-contact-avatar" id="chatContactAvatar">A</div>
                    <div class="chat-contact-info">
                        <h3 style="color:white;" id="chatContactName">–ê–ª–µ–∫—Å–µ–π</h3>
                        <p style="color:#4caf50; font-size:12px;" id="chatContactStatus">online</p>
                    </div>
                </div>
                <div class="no-chat-selected" id="noChatSelected">
                    <div class="no-chat-icon">üí¨</div>
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</h2>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</p>
                </div>
                <div class="messages" id="messagesContainer" style="display:none;"></div>
                <div class="input-area" id="inputArea" style="display:none;">
                    <input type="text" class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." data-replyto="">
                    <button class="send-button" onclick="sendMessage()">‚Üë</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="error-message" id="editProfileError"></div>
            <input type="text" class="modal-input" id="editName" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="text" class="modal-input" id="editUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (username)" maxlength="20">
            <input type="text" class="modal-input" id="editBio" placeholder="–û —Å–µ–±–µ" maxlength="100">
            <div class="modal-buttons">
                <button class="modal-button save" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="modal-button cancel" onclick="closeEditProfileModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content profile-modal">
            <h2 class="modal-title" id="profileName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <p style="color:#8c9db5; text-align:center;" id="profileUsername">@username</p>
            <p style="color:white; text-align:center; margin:10px 0;" id="profileBio">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:#4fc3f7;">–ë–∞–ª–∞–Ω—Å: <span id="profileSparks">0</span> ‚ú®</h3>
                <button class="buy-sparks-btn" onclick="buySparks()">–ö—É–ø–∏—Ç—å –∏—Å–∫—Ä—ã (–¥–µ–º–æ)</button>
            </div>
            <h3 style="color:#4fc3f7; margin-top:15px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</h3>
            <div class="gift-list" id="availableGifts"></div>
            <h3 style="color:#4fc3f7; margin-top:15px;">–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</h3>
            <div id="receivedGiftsList" style="max-height:150px; overflow-y:auto;"></div>
            <div class="modal-buttons"><button class="modal-button cancel" onclick="closeProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDe9mC7MxuSOrTNPK3ovHBMcGGeZXhVIPc",
            authDomain: "zeltaq-20e65.firebaseapp.com",
            databaseURL: "https://zeltaq-20e65-default-rtdb.firebaseio.com",
            projectId: "zeltaq-20e65",
            storageBucket: "zeltaq-20e65.firebasestorage.app",
            messagingSenderId: "187637453275",
            appId: "1:187637453275:web:0d0e972934e46b3575d7fe",
            measurementId: "G-0CKQKQH35S"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null, selectedContact = null, allUsers = [], currentTab = 'chats', chatsList = [], isMobile = window.innerWidth <= 768, currentProfileUserId = null;
        let currentMessageForContext = null;

        const gifts = [
            { emoji: 'üéÅ', name: '–ü–æ–¥–∞—Ä–æ–∫', price: 10 },
            { emoji: 'üå∏', name: '–¶–≤–µ—Ç–æ–∫', price: 5 },
            { emoji: 'üç´', name: '–®–æ–∫–æ–ª–∞–¥', price: 15 },
            { emoji: 'üéÆ', name: '–î–∂–æ–π—Å—Ç–∏–∫', price: 20 },
            { emoji: 'üíê', name: '–ë—É–∫–µ—Ç', price: 25 }
        ];

        function showLogin() { hideAllForms(); document.getElementById('loginForm').classList.add('active'); hideError('loginError'); }
        function showRegister() { hideAllForms(); document.getElementById('registerForm').classList.add('active'); hideError('registerError'); }
        function hideAllForms() { document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active')); }
        function showError(elId, msg) { const e = document.getElementById(elId); if(e){ e.textContent = msg; e.style.display='block'; } else alert(msg); }
        function hideError(elId) { const e = document.getElementById(elId); if(e) e.style.display='none'; }
        function isValidUsername(u) { return /^[a-zA-Z0-9_.-]+$/.test(u); }

        function register() {
            let username = document.getElementById('registerUsername').value.trim();
            let name = document.getElementById('registerName').value.trim();
            let email = document.getElementById('registerEmail').value.trim();
            let pass = document.getElementById('registerPassword').value;
            let cpass = document.getElementById('registerConfirmPassword').value;
            if (!username || !name || !email || !pass || !cpass) return showError('registerError','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            if (username.length<3) return showError('registerError','–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
            if (!isValidUsername(username)) return showError('registerError','–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã');
            if (pass!==cpass) return showError('registerError','–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            if (pass.length<6) return showError('registerError','–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                let user = cred.user;
                return database.ref('usernames/'+username).transaction(cur => cur?undefined:user.uid).then(res => {
                    if (!res.committed) return user.delete().then(() => { throw new Error('–ò–º—è –∑–∞–Ω—è—Ç–æ'); });
                    return database.ref('users/'+user.uid).set({ username, name, email, bio: '', sparks: 100, createdAt: firebase.database.ServerValue.TIMESTAMP, online: true });
                });
            }).then(() => { currentUser = auth.currentUser; showMessenger(); }).catch(e => {
                console.error(e); let msg = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                if (e.code === 'auth/email-already-in-use') msg = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                else if (e.code === 'auth/invalid-email') msg = '–ù–µ–≤–µ—Ä–Ω—ã–π email';
                else if (e.code === 'auth/weak-password') msg = '–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å';
                else msg = e.message;
                showError('registerError', msg);
            });
        }

        function login() {
            let email = document.getElementById('loginEmail').value.trim();
            let pass = document.getElementById('loginPassword').value;
            if (!email || !pass) return showError('loginError','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
            auth.signInWithEmailAndPassword(email, pass).then(cred => { currentUser = cred.user; showMessenger(); }).catch(e => {
                console.error(e); let msg = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                if (e.code === 'auth/user-not-found') msg = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                else if (e.code === 'auth/wrong-password') msg = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                else msg = e.message;
                showError('loginError', msg);
            });
        }

        function logout() {
            if (currentUser && database) database.ref('users/'+currentUser.uid).update({ online: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });
            auth.signOut().then(() => { location.reload(); });
        }

        function showMessenger() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('messenger').style.display = 'flex';
            loadUserInfo(); loadAllUsers(); switchTab('chats');
            database.ref('users/'+currentUser.uid).update({ online: true });
            window.addEventListener('resize', handleResize); handleResize();
        }

        function handleResize() {
            isMobile = window.innerWidth <= 768;
            if (!isMobile && selectedContact) { document.getElementById('sidebar').style.transform = 'translateX(0)'; document.getElementById('chatArea').classList.remove('active'); }
            else if (isMobile && selectedContact) document.getElementById('chatArea').classList.add('active');
            else if (isMobile && !selectedContact) document.getElementById('chatArea').classList.remove('active');
        }

        function closeChat() { selectedContact = null; document.getElementById('noChatSelected').style.display='flex'; document.getElementById('chatHeader').style.display='none'; document.getElementById('messagesContainer').style.display='none'; document.getElementById('inputArea').style.display='none'; if(isMobile) document.getElementById('chatArea').classList.remove('active'); }

        async function loadUserInfo() {
            if (!database || !currentUser) return;
            try {
                let snap = await database.ref('users/'+currentUser.uid).once('value');
                let data = snap.val();
                if (!data) {
                    let email = currentUser.email || '';
                    let defaultName = email.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    let defaultUsername = defaultName.replace(/[^a-zA-Z0-9_.-]/g,'') || 'user_'+Date.now();
                    data = { username: defaultUsername, name: defaultName, email, bio: '', sparks: 100, createdAt: firebase.database.ServerValue.TIMESTAMP, online: true };
                    await database.ref('users/'+currentUser.uid).set(data);
                    let r = await database.ref('usernames/'+defaultUsername).transaction(c => c?undefined:currentUser.uid);
                    if (!r.committed) {
                        let newU = defaultUsername+'_'+Math.floor(Math.random()*1000);
                        await database.ref('usernames/'+newU).set(currentUser.uid);
                        data.username = newU;
                        await database.ref('users/'+currentUser.uid).update({ username: newU });
                    }
                }
                document.getElementById('userAvatar').textContent = (data.name||'U').charAt(0).toUpperCase();
                document.getElementById('userAvatar').style.background = getRandomColor();
                currentUser.data = data;
            } catch(e) { console.error(e); }
        }

        function loadAllUsers() {
            if (!database||!currentUser) return;
            database.ref('users').on('value', snap => {
                let users = snap.val(); allUsers = [];
                if (users) for (let id in users) if (id !== currentUser.uid) allUsers.push({ id, ...users[id] });
                let inp = document.getElementById('searchInput');
                if (inp && inp.value.trim().length && currentTab==='global') searchUsers(inp.value.trim());
            }, e => { console.error(e); alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'); });
        }

        function switchTab(tab) {
            currentTab = tab;
            ['chats','global'].forEach(t => document.getElementById(t+'Tab')?.classList.remove('active'));
            document.getElementById(tab+'Tab').classList.add('active');
            let sc = document.getElementById('searchContainer'); 
            sc.style.display = tab === 'global' ? 'block' : 'none';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
            let cl = document.getElementById('contactList');
            if (tab==='chats') { loadChats(); }
            else { cl.innerHTML = '<p style="color:#8c9db5; text-align:center; margin-top:20px;">–í–≤–µ–¥–∏—Ç–µ username –¥–ª—è –ø–æ–∏—Å–∫–∞</p>'; }
        }

        function loadChats() {
            if (!database||!currentUser) return;
            document.getElementById('contactList').innerHTML = '<p style="color:#8c9db5; text-align:center; margin-top:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>';
            database.ref('chats').once('value', snap => {
                let all = snap.val(), promises = [];
                if (all) for (let cid in all) {
                    let parts = cid.split('_');
                    if (parts.includes(currentUser.uid)) {
                        let contactId = parts.find(id => id !== currentUser.uid);
                        let msgs = all[cid], lastMsg = null, lastTs = 0;
                        for (let k in msgs) { let m = msgs[k]; if (m.timestamp > lastTs) { lastTs = m.timestamp; lastMsg = m; } }
                        promises.push(database.ref('users/'+contactId).once('value').then(s => ({ contactId, contactData: s.val(), lastMsg, lastTs })));
                    }
                }
                Promise.all(promises).then(chats => {
                    chats.sort((a,b) => (b.lastTs||0)-(a.lastTs||0));
                    displayChats(chats);
                }).catch(e => { console.error(e); document.getElementById('contactList').innerHTML = '<p style="color:#ff5252; text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'; });
            });
        }

        function displayChats(chats) {
            let cl = document.getElementById('contactList');
            if (!chats.length) { cl.innerHTML = '<p style="color:#8c9db5; text-align:center; margin-top:20px;">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –ø–æ–∏—Å–∫–µ.</p>'; return; }
            cl.innerHTML = '';
            chats.forEach(c => {
                let contact = c.contactData || {};
                let name = contact.name || contact.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                let last = c.lastMsg ? (c.lastMsg.type==='gift' ? 'üéÅ –ü–æ–¥–∞—Ä–æ–∫' : c.lastMsg.text) : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                let time = c.lastTs ? new Date(c.lastTs).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                let div = document.createElement('div'); div.className = 'contact';
                div.innerHTML = `<div class="contact-avatar" style="background:${getRandomColor()};">${name.charAt(0).toUpperCase()}<div class="${contact.online ? 'contact-online' : 'contact-offline'}"></div></div><div class="contact-info"><h4>${name}</h4><p>${last} ¬∑ ${time}</p></div>`;
                div.addEventListener('click',() => selectContact(c.contactId, name, contact.username));
                cl.appendChild(div);
            });
        }

        function selectContact(id, name, username) {
            selectedContact = { id, name, username };
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('messagesContainer').style.display = 'flex';
            document.getElementById('inputArea').style.display = 'flex';
            document.getElementById('chatContactName').textContent = name;
            document.getElementById('chatContactAvatar').textContent = name.charAt(0).toUpperCase();
            document.getElementById('chatContactAvatar').style.background = getRandomColor();
            database.ref('users/'+id).once('value').then(s => {
                let online = s.val()?.online;
                document.getElementById('chatContactStatus').textContent = online ? 'online' : 'offline';
                document.getElementById('chatContactStatus').style.color = online ? '#4caf50' : '#ff5252';
            });
            loadMessages(id);
            subscribeToMessages(id);
            if (isMobile) document.getElementById('chatArea').classList.add('active');
        }

        function loadMessages(contactId) {
            if (!database||!currentUser) return;
            let mc = document.getElementById('messagesContainer'); mc.innerHTML = '';
            let chatId = [currentUser.uid, contactId].sort().join('_');
            database.ref('chats/'+chatId).orderByChild('timestamp').limitToLast(50).once('value').then(snap => {
                let msgs = snap.val();
                if (msgs) { Object.keys(msgs).forEach(k => displayMessage(msgs[k])); mc.scrollTop = mc.scrollHeight; }
                else mc.innerHTML = '<div style="text-align:center; color:#8c9db5; margin-top:20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>';
            });
        }

        function subscribeToMessages(contactId) {
            if (!database||!currentUser) return;
            let chatId = [currentUser.uid, contactId].sort().join('_');
            // –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            database.ref('chats/'+chatId).orderByChild('timestamp').limitToLast(1).on('child_added', snap => {
                let m = snap.val();
                if (!document.getElementById(m.timestamp)) { displayMessage(m); document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight; }
            });
            // –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            database.ref('chats/'+chatId).on('child_changed', snap => {
                let m = snap.val();
                let el = document.getElementById(m.timestamp);
                if (el) {
                    let newEl = createMessageElement(m);
                    el.replaceWith(newEl);
                }
            });
            // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
            database.ref('chats/'+chatId).on('child_removed', snap => {
                let id = snap.key;
                let el = document.getElementById(id);
                if (el) el.remove();
            });
        }

        function createMessageElement(m) {
            let div = document.createElement('div');
            let isMe = m.senderId === currentUser.uid;
            let time = new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            let replyHtml = '';
            if (m.replyTo) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º id —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º, –≤ data-–∞—Ç—Ä–∏–±—É—Ç
                replyHtml = `<div class="reply-indicator" data-replyto-id="${m.replyTo.messageId}" onclick="jumpToMessage(this.dataset.replytoId)">‚Ü©Ô∏è ${m.replyTo.senderName}: ${m.replyTo.text.substring(0,30)}...</div>`;
            }
            let editedHtml = m.edited ? '<span class="edited-indicator">(—Ä–µ–¥.)</span>' : '';
            if (m.type === 'gift') {
                div.className = 'gift-message';
                div.id = m.timestamp;
                div.innerHTML = `
                    <div class="gift-emoji">${m.giftEmoji}</div>
                    <div>üéÅ ${m.giftName}</div>
                    <div class="gift-sender">–æ—Ç ${m.senderName}</div>
                    <div class="message-time">${time}</div>
                `;
            } else {
                div.className = `message ${isMe ? 'sent' : 'received'}`;
                div.id = m.timestamp;
                div.setAttribute('data-sender', m.senderId);
                div.setAttribute('data-type', 'text');
                div.innerHTML = `
                    ${replyHtml}
                    ${m.text || ''}
                    ${editedHtml}
                    <div class="message-time">${time}</div>
                `;
            }
            div.oncontextmenu = (e) => showContextMenu(e, m);
            return div;
        }

        function displayMessage(m) {
            let mc = document.getElementById('messagesContainer');
            mc.appendChild(createMessageElement(m));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—Ç–∏–ª–∏
        function jumpToMessage(messageId) {
            let target = document.getElementById(messageId);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–∏–º –µ–≥–æ
                target.style.transition = 'background 0.3s';
                target.style.backgroundColor = 'rgba(79,195,247,0.3)';
                setTimeout(() => { target.style.backgroundColor = ''; }, 1000);
            } else {
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ)');
            }
        }

        function sendMessage() {
            if (!selectedContact || !database || !currentUser) return;
            let inp = document.getElementById('messageInput');
            let text = inp.value.trim();
            if (!text) return;
            let ts = Date.now();
            let chatId = [currentUser.uid, selectedContact.id].sort().join('_');
            let senderName = currentUser.data?.name || currentUser.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            let message = { senderId: currentUser.uid, senderName, text, timestamp: ts };
            // –ï—Å–ª–∏ –µ—Å—Ç—å replyTo
            let replyToId = inp.dataset.replyto;
            if (replyToId) {
                // –ò—â–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ —Ç–µ–∫—Å—Ç)
                let replyEl = document.getElementById(replyToId);
                if (replyEl) {
                    let replySenderName = replyEl.classList.contains('sent') ? currentUser.data.name : (selectedContact.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                    // –¢–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏, –Ω–æ –ø—Ä–æ—â–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ, —á—Ç–æ –µ—Å—Ç—å.
                    message.replyTo = {
                        messageId: replyToId,
                        senderName: replySenderName,
                        text: '...' // –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∞—Ç—å –∏–∑ DOM, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ
                    };
                }
                inp.dataset.replyto = '';
                inp.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
            }
            database.ref('chats/'+chatId+'/'+ts).set(message).then(() => inp.value='').catch(e => alert('–û—à–∏–±–∫–∞'));
        }

        function getRandomColor() { let c = ['#4fc3f7','#4db6ac','#ba68c8','#ff8a65','#7986cb','#4dd0e1','#a1887f']; return c[Math.floor(Math.random()*c.length)]; }

        document.getElementById('messageInput')?.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });
        document.addEventListener('click', e => { if(!e.target.closest('.context-menu')) document.getElementById('messageContextMenu').style.display='none'; });

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        function showContextMenu(e, message) {
            e.preventDefault();
            currentMessageForContext = message;
            let menu = document.getElementById('messageContextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            let isMine = message.senderId === currentUser.uid;
            let items = menu.children;
            items[1].style.display = isMine ? 'block' : 'none'; // edit
            items[2].style.display = isMine ? 'block' : 'none'; // delete
        }

        function contextMenuAction(action) {
            let menu = document.getElementById('messageContextMenu');
            menu.style.display = 'none';
            if (!currentMessageForContext) return;
            if (action === 'reply') {
                replyToMessage(currentMessageForContext);
            } else if (action === 'edit') {
                editMessage(currentMessageForContext);
            } else if (action === 'delete') {
                deleteMessage(currentMessageForContext);
            }
        }

        function replyToMessage(msg) {
            let input = document.getElementById('messageInput');
            input.placeholder = `–û—Ç–≤–µ—Ç ${msg.senderName}: ${msg.text.substring(0,20)}...`;
            input.dataset.replyto = msg.timestamp;
            input.focus();
        }

        function editMessage(msg) {
            let newText = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', msg.text);
            if (newText && newText !== msg.text) {
                let chatId = [currentUser.uid, selectedContact.id].sort().join('_');
                database.ref('chats/' + chatId + '/' + msg.timestamp).update({
                    text: newText,
                    edited: true
                });
            }
        }

        function deleteMessage(msg) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            let chatId = [currentUser.uid, selectedContact.id].sort().join('_');
            database.ref('chats/' + chatId + '/' + msg.timestamp).remove();
        }

        // –ü—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–¥–∞—Ä–∫–∏
        function openEditProfileModal() {
            if (!currentUser?.data) return;
            document.getElementById('editName').value = currentUser.data.name || '';
            document.getElementById('editUsername').value = currentUser.data.username || '';
            document.getElementById('editBio').value = currentUser.data.bio || '';
            document.getElementById('editProfileError').style.display = 'none';
            document.getElementById('editProfileModal').classList.add('active');
        }
        function closeEditProfileModal() { document.getElementById('editProfileModal').classList.remove('active'); }
        async function saveProfile() {
            let name = document.getElementById('editName').value.trim();
            let username = document.getElementById('editUsername').value.trim();
            let bio = document.getElementById('editBio').value.trim();
            if (!name || !username) return showError('editProfileError','–ò–º—è –∏ username –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
            if (username.length<3 || !isValidUsername(username)) return showError('editProfileError','–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π username');
            let old = currentUser.data.username;
            if (username === old) {
                await database.ref('users/'+currentUser.uid).update({ name, bio });
                currentUser.data.name = name; currentUser.data.bio = bio;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                closeEditProfileModal(); return;
            }
            let ref = database.ref('usernames/'+username);
            let res = await ref.transaction(v => v?undefined:currentUser.uid);
            if (!res.committed) return showError('editProfileError','–ò–º—è –∑–∞–Ω—è—Ç–æ');
            await database.ref('usernames/'+old).remove();
            await database.ref('users/'+currentUser.uid).update({ name, username, bio });
            currentUser.data.name = name; currentUser.data.username = username; currentUser.data.bio = bio;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            closeEditProfileModal();
        }

        function openProfileModal(userId) {
            if (!userId) return;
            currentProfileUserId = userId;
            database.ref('users/'+userId).once('value').then(snap => {
                let u = snap.val();
                if (!u) return;
                document.getElementById('profileName').textContent = u.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                document.getElementById('profileUsername').textContent = '@'+(u.username||'');
                document.getElementById('profileBio').textContent = u.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                document.getElementById('profileSparks').textContent = u.sparks || 0;
                renderAvailableGifts(u.sparks || 0);
                loadReceivedGifts(userId);
                document.getElementById('userProfileModal').classList.add('active');
            });
        }
        function closeProfileModal() { document.getElementById('userProfileModal').classList.remove('active'); }

        function renderAvailableGifts(balance) {
            let container = document.getElementById('availableGifts'); container.innerHTML = '';
            gifts.forEach(g => {
                let div = document.createElement('div'); div.className = 'gift-item';
                div.innerHTML = `<div class="gift-emoji">${g.emoji}</div><div class="gift-price">${g.price}‚ú®</div>`;
                div.onclick = () => sendGift(currentProfileUserId, g);
                if (balance < g.price) div.style.opacity = '0.5';
                container.appendChild(div);
            });
        }

        async function sendGift(toUserId, gift) {
            if (!currentUser) return;
            let balance = currentUser.data.sparks || 0;
            if (balance < gift.price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å–∫—Ä'); return; }
            try {
                await database.ref('users/'+currentUser.uid).update({ sparks: balance - gift.price });
                currentUser.data.sparks = balance - gift.price;
                let giftData = { from: currentUser.uid, to: toUserId, emoji: gift.emoji, name: gift.name, timestamp: Date.now() };
                await database.ref('gifts/' + toUserId + '/' + Date.now()).set(giftData);
                // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                let chatId = [currentUser.uid, toUserId].sort().join('_');
                let ts = Date.now();
                await database.ref('chats/'+chatId+'/'+ts).set({
                    senderId: currentUser.uid,
                    senderName: currentUser.data.name,
                    type: 'gift',
                    giftEmoji: gift.emoji,
                    giftName: gift.name,
                    timestamp: ts
                });
                alert('–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                closeProfileModal();
            } catch(e) { console.error(e); alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞'); }
        }

        function loadReceivedGifts(userId) {
            database.ref('gifts/'+userId).orderByChild('timestamp').limitToLast(20).once('value', snap => {
                let list = document.getElementById('receivedGiftsList'); list.innerHTML = '';
                snap.forEach(child => {
                    let g = child.val();
                    database.ref('users/'+g.from).once('value').then(s => {
                        let fromUser = s.val();
                        let div = document.createElement('div'); div.className = 'received-gift';
                        div.innerHTML = `<span class="gift-emoji">${g.emoji}</span> <span style="color:white;">${g.name}</span> <span style="color:#8c9db5;">–æ—Ç ${fromUser?.name || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>`;
                        div.onclick = () => openProfileModal(g.from);
                        list.appendChild(div);
                    });
                });
            });
        }

        function buySparks() {
            if (!currentUser) return;
            let newBalance = (currentUser.data.sparks || 0) + 100;
            database.ref('users/'+currentUser.uid).update({ sparks: newBalance });
            currentUser.data.sparks = newBalance;
            document.getElementById('profileSparks').textContent = newBalance;
            renderAvailableGifts(newBalance);
        }

        // –ü–æ–∏—Å–∫
        function searchUsers(term) {
            let res = document.getElementById('searchResults');
            term = term.toLowerCase().trim();
            if (term.length<1) { res.style.display='none'; return; }
            let filtered = allUsers.filter(u => u.username && u.username.toLowerCase().includes(term));
            res.innerHTML = '';
            if (!filtered.length) { res.innerHTML = '<div class="search-result-item" style="justify-content:center;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; res.style.display='block'; return; }
            filtered.forEach(u => {
                let name = u.name || u.username || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                let d = document.createElement('div'); d.className = 'search-result-item';
                d.innerHTML = `<div class="contact-avatar" style="background:${getRandomColor()}; width:40px;height:40px;">${name.charAt(0).toUpperCase()}<div class="${u.online?'contact-online':'contact-offline'}"></div></div><div><h4 style="color:white;">${name}</h4><p style="color:#8c9db5;">@${u.username}</p></div>`;
                d.onclick = () => { selectContact(u.id, name, u.username); res.style.display='none'; document.getElementById('searchInput').value=''; };
                res.appendChild(d);
            });
            res.style.display='block';
        }

        document.getElementById('searchInput')?.addEventListener('input', e => { if(currentTab==='global') searchUsers(e.target.value); });

        auth.onAuthStateChanged(user => { if(user) { currentUser = user; showMessenger(); } });
    </script>
</body>
</html>